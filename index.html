<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Madison Giant Santa Tracker üéÖ</title>
  
  <!-- Leaflet CSS & JS for interactive maps -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  
  <!-- Papa Parse for CSV parsing -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
  
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Segoe UI', system-ui, sans-serif;
      background: linear-gradient(180deg, #1e3a5f 0%, #0f2744 100%);
      min-height: 100vh;
      color: #333;
    }
    
    /* Snow animation */
    .snowflake {
      position: fixed;
      color: rgba(255,255,255,0.8);
      pointer-events: none;
      z-index: 1;
      animation: snow linear infinite;
    }
    
    @keyframes snow {
      0% { transform: translateY(-10px) rotate(0deg); }
      100% { transform: translateY(100vh) rotate(360deg); }
    }
    
    @keyframes glow {
      0%, 100% { box-shadow: 0 8px 32px rgba(0,0,0,0.4), 0 0 30px rgba(251,191,36,0.4); }
      50% { box-shadow: 0 8px 32px rgba(0,0,0,0.4), 0 0 50px rgba(251,191,36,0.7); }
    }
    
    @keyframes bounce {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-5px); }
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    /* Header */
    header {
      position: relative;
      z-index: 10;
      text-align: center;
      padding: 28px 16px 20px;
    }
    
    .title-badge {
      display: inline-flex;
      align-items: center;
      gap: 12px;
      background: linear-gradient(135deg, #dc2626 0%, #991b1b 100%);
      padding: 14px 32px;
      border-radius: 50px;
      border: 3px solid #fbbf24;
      animation: glow 2s ease-in-out infinite;
    }
    
    .title-badge h1 {
      font-size: 1.5rem;
      color: #fff;
      font-weight: 700;
    }
    
    .title-badge .santa-icon {
      font-size: 2rem;
      animation: bounce 1s ease-in-out infinite;
    }
    
    .subtitle {
      color: rgba(255,255,255,0.8);
      margin-top: 12px;
      font-size: 1rem;
    }
    
    .counter {
      display: inline-block;
      background: rgba(255,255,255,0.15);
      padding: 8px 20px;
      border-radius: 20px;
      margin-top: 10px;
      color: #fff;
    }
    
    .counter .count {
      color: #fbbf24;
      font-weight: 700;
      font-size: 1.3rem;
    }
    
    /* Main content */
    .container {
      position: relative;
      z-index: 10;
      max-width: 700px;
      margin: 0 auto;
      padding: 0 16px 40px;
    }
    
    /* Map */
    .map-container {
      background: #fff;
      border-radius: 16px;
      overflow: hidden;
      box-shadow: 0 12px 40px rgba(0,0,0,0.3);
      border: 4px solid #dc2626;
      margin-bottom: 20px;
    }
    
    .map-header {
      padding: 12px 16px;
      background: #fef2f2;
      border-bottom: 2px solid #fecaca;
      font-weight: 600;
      color: #991b1b;
    }
    
    #map {
      height: 400px;
      width: 100%;
      position: relative;
    }
    
    /* Loading state */
    .loading-overlay {
      position: absolute;
      inset: 0;
      background: rgba(255,255,255,0.95);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }
    
    .loading-overlay.hidden {
      display: none;
    }
    
    .spinner {
      width: 50px;
      height: 50px;
      border: 4px solid #fecaca;
      border-top-color: #dc2626;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-bottom: 12px;
    }
    
    .loading-text {
      color: #991b1b;
      font-weight: 600;
    }
    
    /* Selected santa card */
    .selected-santa {
      background: linear-gradient(135deg, #fef2f2 0%, #fff 100%);
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 16px;
      border: 2px solid #fca5a5;
      display: none;
      align-items: center;
      gap: 14px;
      flex-wrap: wrap;
    }
    
    .selected-santa.visible {
      display: flex;
    }
    
    .selected-santa .santa-emoji {
      font-size: 2.5rem;
    }
    
    .selected-santa .info {
      flex: 1;
      min-width: 150px;
    }
    
    .selected-santa .address {
      font-weight: 700;
      color: #dc2626;
      font-size: 1.1rem;
    }
    
    .selected-santa .submitter {
      color: #666;
      font-size: 0.85rem;
    }
    
    .maps-link {
      background: #166534;
      color: #fff;
      padding: 10px 16px;
      border-radius: 8px;
      text-decoration: none;
      font-weight: 600;
      font-size: 0.85rem;
      white-space: nowrap;
    }
    
    .maps-link:hover {
      background: #14532d;
    }
    
    /* Santa list */
    .santa-list {
      background: rgba(255,255,255,0.95);
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 16px;
    }
    
    .santa-list h3 {
      margin-bottom: 12px;
      color: #166534;
      font-size: 1rem;
    }
    
    .santa-buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }
    
    .santa-btn {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 8px 12px;
      background: #f0fdf4;
      border: 2px solid #86efac;
      border-radius: 20px;
      cursor: pointer;
      font-size: 0.85rem;
      font-weight: 500;
      color: #333;
      transition: all 0.15s ease;
    }
    
    .santa-btn:hover {
      background: #dcfce7;
    }
    
    .santa-btn.selected {
      background: #fee2e2;
      border-color: #dc2626;
    }
    
    .no-santas {
      color: #666;
      font-style: italic;
    }
    
    /* Submit CTA */
    .submit-cta {
      background: linear-gradient(135deg, #fff 0%, #f0fdf4 100%);
      border-radius: 16px;
      padding: 24px;
      border: 3px solid #166534;
      text-align: center;
    }
    
    .submit-cta h2 {
      margin-bottom: 12px;
      color: #dc2626;
      font-size: 1.3rem;
    }
    
    .submit-cta p {
      color: #666;
      margin-bottom: 16px;
    }
    
    .submit-btn {
      display: inline-block;
      padding: 14px 32px;
      font-size: 1.1rem;
      font-weight: 700;
      color: #fff;
      background: linear-gradient(135deg, #dc2626 0%, #991b1b 100%);
      border: none;
      border-radius: 50px;
      cursor: pointer;
      box-shadow: 0 4px 12px rgba(220,38,38,0.3);
      text-decoration: none;
      transition: transform 0.15s, box-shadow 0.15s;
    }
    
    .submit-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(220,38,38,0.4);
    }
    
    /* Footer */
    footer {
      position: relative;
      z-index: 10;
      text-align: center;
      padding: 20px;
      color: rgba(255,255,255,0.5);
      font-size: 0.85rem;
    }
    
    /* Leaflet popup styling */
    .santa-popup {
      text-align: center;
    }
    
    .santa-popup .popup-emoji {
      font-size: 2rem;
      margin-bottom: 8px;
    }
    
    .santa-popup .popup-address {
      font-weight: 700;
      color: #dc2626;
      margin-bottom: 4px;
    }
    
    .santa-popup .popup-submitter {
      font-size: 0.85rem;
      color: #666;
    }
    
    /* Error message */
    .error-message {
      background: #fee2e2;
      color: #991b1b;
      padding: 16px;
      border-radius: 12px;
      margin-bottom: 16px;
      text-align: center;
      display: none;
    }
    
    .error-message.visible {
      display: block;
    }
  </style>
</head>
<body>
  
  <!-- Snowflakes -->
  <div id="snow-container"></div>
  
  <!-- Header -->
  <header>
    <div class="title-badge">
      <span class="santa-icon">üéÖ</span>
      <h1>Madison Giant Santa Tracker</h1>
      <span class="santa-icon" style="animation-delay: 0.3s">üéÖ</span>
    </div>
    <p class="subtitle">Mapping every glorious 12-foot inflatable in the city!</p>
    <div class="counter">
      <span class="count" id="santa-count">0</span> Santas spotted!
    </div>
  </header>
  
  <!-- Main Content -->
  <div class="container">
    
    <!-- Error message -->
    <div class="error-message" id="error-message"></div>
    
    <!-- Map -->
    <div class="map-container">
      <div class="map-header">üó∫Ô∏è Madison, WI ‚Äî Click a Santa for details</div>
      <div id="map">
        <div class="loading-overlay" id="loading">
          <div class="spinner"></div>
          <div class="loading-text">Loading Santa sightings...</div>
        </div>
      </div>
    </div>
    
    <!-- Selected Santa Detail -->
    <div class="selected-santa" id="selected-santa">
      <span class="santa-emoji">üéÖ</span>
      <div class="info">
        <div class="address" id="selected-address"></div>
        <div class="submitter" id="selected-submitter"></div>
      </div>
      <a class="maps-link" id="selected-link" href="#" target="_blank">Open in Maps ‚Üó</a>
    </div>
    
    <!-- Santa List -->
    <div class="santa-list">
      <h3>üìç All Sightings</h3>
      <div class="santa-buttons" id="santa-buttons">
        <span class="no-santas">Loading...</span>
      </div>
    </div>
    
    <!-- Submit CTA -->
    <div class="submit-cta">
      <h2>üéÖ Spot a Giant Santa?</h2>
      <p>Help us map all the 12-foot inflatable Santas in Madison!</p>
      <a 
        href="https://docs.google.com/forms/d/e/1FAIpQLSeCsUBFgD1AVRr7pJVdaLkMY4WqREYR5rjgcOH6G-lbg5GC8Q/viewform" 
        target="_blank" 
        class="submit-btn"
      >
        üìç Submit a Sighting!
      </a>
    </div>
    
  </div>
  
  <footer>
    Made with ‚ù§Ô∏è in Madison, WI ‚Ä¢ Happy Holidays! üéÑ
  </footer>
  
  <script>
    // ============ CONFIGURATION ============
    const GOOGLE_SHEET_CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRdG78w6csiqzQtWUCGQGTCCaOSB_WDrVk2yGeITPcoXWi98jtQZmcU6WcIU_cQ5uxA0xCEcgUwdY5i/pub?output=csv';
    
    // Cache key for geocoded addresses
    const GEOCODE_CACHE_KEY = 'santa_tracker_geocode_cache';
    
    // ============ STATE ============
    let santas = [];
    let selectedSanta = null;
    let map;
    let markers = [];
    
    // ============ GEOCODE CACHE ============
    function getGeocodeCache() {
      try {
        return JSON.parse(localStorage.getItem(GEOCODE_CACHE_KEY)) || {};
      } catch {
        return {};
      }
    }
    
    function saveGeocodeCache(cache) {
      try {
        localStorage.setItem(GEOCODE_CACHE_KEY, JSON.stringify(cache));
      } catch {
        // localStorage might be full or disabled
      }
    }
    
    // ============ GEOCODING ============
    async function geocodeAddress(address) {
      const cache = getGeocodeCache();
      const cacheKey = address.toLowerCase().trim();
      
      if (cache[cacheKey]) {
        return cache[cacheKey];
      }
      
      const query = encodeURIComponent(`${address}, Madison, WI`);
      try {
        const response = await fetch(
          `https://nominatim.openstreetmap.org/search?format=json&q=${query}&limit=1`,
          { headers: { 'User-Agent': 'MadisonSantaTracker/1.0' } }
        );
        const data = await response.json();
        
        if (data.length > 0) {
          const result = {
            lat: parseFloat(data[0].lat),
            lng: parseFloat(data[0].lon)
          };
          
          cache[cacheKey] = result;
          saveGeocodeCache(cache);
          
          return result;
        }
      } catch (err) {
        console.error('Geocoding error:', err);
      }
      
      return null;
    }
    
    // ============ LOAD DATA FROM GOOGLE SHEET ============
    async function loadSantasFromSheet() {
      return new Promise((resolve, reject) => {
        Papa.parse(GOOGLE_SHEET_CSV_URL, {
          download: true,
          header: true,
          complete: async (results) => {
            console.log('CSV loaded:', results.data);
            
            // Filter for rows with an address (check multiple possible column names)
            const rows = results.data.filter(row => {
              const address = row['Address'] || row['address'] || row['ADDRESS'] || '';
              return address.trim() !== '';
            });
            
            console.log('Rows with addresses:', rows);
            
            // Geocode each address with rate limiting
            const santaList = [];
            for (let i = 0; i < rows.length; i++) {
              const row = rows[i];
              const address = row['Address'] || row['address'] || row['ADDRESS'];
              const name = row['Your Name'] || row['Name'] || row['name'] || row['YOUR NAME'] || 'Anonymous Elf';
              
              // Rate limit: wait 300ms between geocode requests
              if (i > 0) {
                await new Promise(r => setTimeout(r, 300));
              }
              
              const coords = await geocodeAddress(address);
              
              if (coords) {
                santaList.push({
                  id: i + 1,
                  lat: coords.lat,
                  lng: coords.lng,
                  address: address,
                  submitter: name || 'Anonymous Elf'
                });
              }
            }
            
            resolve(santaList);
          },
          error: (error) => {
            console.error('CSV parse error:', error);
            reject(error);
          }
        });
      });
    }
    
    // ============ INITIALIZE MAP ============
    function initMap() {
      map = L.map('map').setView([43.073, -89.40], 12);
      
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '¬© OpenStreetMap contributors'
      }).addTo(map);
    }
    
    // ============ UPDATE MARKERS ============
    function updateMarkers() {
      markers.forEach(m => map.removeLayer(m));
      markers = [];
      
      const santaIcon = L.divIcon({
        className: 'santa-marker',
        html: `<div style="
          font-size: 28px;
          filter: drop-shadow(2px 2px 3px rgba(0,0,0,0.3));
          cursor: pointer;
        ">üéÖ</div>`,
        iconSize: [30, 30],
        iconAnchor: [15, 30],
        popupAnchor: [0, -30]
      });
      
      santas.forEach(santa => {
        const marker = L.marker([santa.lat, santa.lng], { icon: santaIcon })
          .addTo(map)
          .bindPopup(`
            <div class="santa-popup">
              <div class="popup-emoji">üéÖ</div>
              <div class="popup-address">${santa.address}</div>
              <div class="popup-submitter">Spotted by: ${santa.submitter}</div>
            </div>
          `);
        
        marker.on('click', () => selectSanta(santa));
        markers.push(marker);
      });
      
      if (markers.length > 0) {
        const group = L.featureGroup(markers);
        map.fitBounds(group.getBounds().pad(0.1));
      }
    }
    
    // ============ SELECT SANTA ============
    function selectSanta(santa) {
      selectedSanta = santa;
      
      const card = document.getElementById('selected-santa');
      card.classList.add('visible');
      document.getElementById('selected-address').textContent = santa.address;
      document.getElementById('selected-submitter').textContent = `Spotted by ${santa.submitter}`;
      document.getElementById('selected-link').href = `https://www.google.com/maps/search/?api=1&query=${santa.lat},${santa.lng}`;
      
      document.querySelectorAll('.santa-btn').forEach(btn => {
        btn.classList.toggle('selected', parseInt(btn.dataset.id) === santa.id);
      });
      
      map.setView([santa.lat, santa.lng], 15);
    }
    
    // ============ RENDER SANTA BUTTONS ============
    function renderSantaButtons() {
      const container = document.getElementById('santa-buttons');
      container.innerHTML = '';
      
      if (santas.length === 0) {
        container.innerHTML = '<span class="no-santas">No Santas yet ‚Äî be the first to submit one!</span>';
      } else {
        santas.forEach(santa => {
          const btn = document.createElement('button');
          btn.className = 'santa-btn';
          btn.dataset.id = santa.id;
          btn.innerHTML = `üéÖ ${santa.address}`;
          btn.onclick = () => selectSanta(santa);
          container.appendChild(btn);
        });
      }
      
      document.getElementById('santa-count').textContent = santas.length;
    }
    
    // ============ SHOW ERROR ============
    function showError(message) {
      const el = document.getElementById('error-message');
      el.textContent = message;
      el.classList.add('visible');
    }
    
    // ============ SNOW EFFECT ============
    function createSnowflakes() {
      const container = document.getElementById('snow-container');
      
      for (let i = 0; i < 50; i++) {
        const flake = document.createElement('div');
        flake.className = 'snowflake';
        flake.textContent = '‚ùÑ';
        flake.style.left = `${Math.random() * 100}%`;
        flake.style.fontSize = `${6 + Math.random() * 12}px`;
        flake.style.animationDuration = `${3 + Math.random() * 7}s`;
        flake.style.animationDelay = `${Math.random() * 5}s`;
        container.appendChild(flake);
      }
    }
    
    // ============ INIT ============
    document.addEventListener('DOMContentLoaded', async () => {
      initMap();
      createSnowflakes();
      
      try {
        santas = await loadSantasFromSheet();
        updateMarkers();
        renderSantaButtons();
      } catch (err) {
        console.error('Failed to load santas:', err);
        showError('Could not load Santa sightings. Please try refreshing the page.');
        renderSantaButtons();
      }
      
      document.getElementById('loading').classList.add('hidden');
    });
  </script>
  
</body>
</html>
